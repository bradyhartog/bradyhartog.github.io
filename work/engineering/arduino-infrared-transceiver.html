<!DOCTYPE HTML>
<html>
    <head>
        <link type="text/css" rel="stylesheet" href="../../work.css"/>
        <link href="../../Images/Favicon.png" rel="icon" type="image/x-icon"/>
        <link rel="apple-touch-icon" href="../../Images/Apple%20Touch%20Icon.png">
        <title>Brady Hartog | Engineering</title>
        
        <script type=text/javascript>
            function showWorkMenu() {
                var x = document.getElementById("work-menu");
                if (x.style.display === "block") {
                    x.style.display = "none";
                } else {
                    x.style.display = "block";
                }
            }
        </script>
    </head>
    
<body>
    <div id="page">
        <div id="menu">
            <p class="menu-item", id = "title"><a href="../../index.html">Brady Hartog</a></p>

            <p class="menu-item", id="about"><a href="../../about.html">About</a></p>

            <input type="checkbox", id="work-highlight">
            <label for="work-highlight">
                <p class="menu-item", id="work", onclick="showWorkMenu()">Work</p>
            </label>

            <div id="work-menu">
                <p class="menu-item"><a href="../engineering.html">Engineering</a></p>

                <p class="menu-item"><a href="../design.html">Design</a></p>

                <p class="menu-item"><a href="../music.html">Music</a></p>

                <p class="menu-item"><a href="../photos.html">Photos</a></p>

                <p class="menu-item"><a href="../presentations.html">Presentations</a></p>
            </div>

            <p class="menu-item", id="contact"><a href="../../contact.html">Contact</a></p>

            <p id="copyright-desktop">&#169; 2020 Brady Hartog</p>
        </div>
        
        <div id="content">
            <p id="page-previous"><img id="back-arrow", src="../../Images/Arrow.png"><a href="../engineering.html">Engineering</a></p>
            
            <div class="header-image"></div>
            
            <h1 class="article-title">Arduino Infrared Transceiver</h1>
            
            <h2 class="article-subtitle">University of Utah â€” 2018</h2>
            
            <div class="article-section">
                <p class="article-body">This page is currently in progress.</p>
            </div>
            
            <!-- HTML generated using hilite.me -->
            <div class="code"><pre style="margin: 0;color: #404040;line-height: 125%;">
<span style="color: #008000">/*</span>
<span style="color: #008000">   A robust IR communications protocol for Arduino. Will transmit</span>
<span style="color: #008000">   and receive messages notwithstanding blocking interference,</span>
<span style="color: #008000">   extraneous IR interference, and simultaneous messages from</span>
<span style="color: #008000">   the partner board.</span>

<span style="color: #008000">   Kelsey Tyler and Brady Hartog</span>
<span style="color: #008000">   06 December 2018</span>
<span style="color: #008000">*/</span>

<span style="color: #008000">// GLOBAL VARIABLES</span>

<span style="color: #2b91af">double</span> d                = 0.5;  <span style="color: #008000">// Number of milliseconds in each pulse.</span>
<span style="color: #2b91af">bool</span>   transmitting_IR;         <span style="color: #008000">// Whether this board is currently transmitting.</span>
<span style="color: #2b91af">bool</span>   receiving_IR;            <span style="color: #008000">// Whether this board is currently receiving.</span>
<span style="color: #2b91af">int</span>    serial           = 0;    <span style="color: #008000">// The serial number for messages sent from this board.</span>
<span style="color: #2b91af">int</span>    prev_serial      = 1;    <span style="color: #008000">// The most previous serial message number.</span>
<span style="color: #2b91af">int</span>    serial_check     = -2;   <span style="color: #008000">// For holding the serial number to confirm.</span>
<span style="color: #2b91af">int</span>    read_code        = 0;    <span style="color: #008000">// Indicates whether there is a message to send.</span>
<span style="color: #2b91af">int</span>    code             = -1;   <span style="color: #008000">// Contains the current character in the message.</span>

<span style="color: #008000">// HELPER FUNCTIONS</span>

<span style="color: #008000">/*</span>
<span style="color: #008000">   Turns off the infrared LED (the transmitter).</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">void</span> turn_off_IR() {
  <span style="color: #008000">// Instead of merely adjusting the output on pin 11, this code also</span>
  <span style="color: #008000">//   turns off the timer controlling the PWM output on pin 11.</span>

  TCCR2A = 0;  <span style="color: #008000">// Disconnect PWM</span>
  TCCR2B = 0;  <span style="color: #008000">// Stops the timer</span>
  OCR2A = 0;   <span style="color: #008000">// No timer top</span>
  digitalWrite(11, LOW);  <span style="color: #008000">// Ensure output is off</span>

  transmitting_IR = false;
}

<span style="color: #008000">/*</span>
<span style="color: #008000">   Turns on the infrared LED (the transmitter). Note that it</span>
<span style="color: #008000">   should remain on for at least 8 periods of a 38 kHz signal</span>
<span style="color: #008000">   (211 us), or the receivers may not detect it.</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">void</span> turn_on_IR() {
  <span style="color: #008000">// Set up Timer2 (which can be connected to pins 3 and 11).</span>
  <span style="color: #008000">// For full details, see:</span>
  <span style="color: #008000">//   arduino.cc/en/Tutorial/SecretsOfArduinoPWM</span>

  TCCR2A = _BV(WGM21) | _BV(COM2A0);  <span style="color: #008000">// This mode toggles output once per timer cycle.</span>
  TCCR2B = _BV(CS20);  <span style="color: #008000">// Do not scale the clock down--use 16 MHz timer rate.</span>
  OCR2A = 210;  <span style="color: #008000">// Divide sys. clock by 210, 1/2 cycle = 76 khz, 1 cycle = 38 khz.</span>

  <span style="color: #008000">// Output pin 11 should now be emitting a 38 khz signal.</span>

  transmitting_IR = true;
}

<span style="color: #008000">/*</span>
<span style="color: #008000">   Returns true iff the infrared receiver is detecting a 38 kHz</span>
<span style="color: #008000">   infrared signal. (See the datasheet for this part for additional</span>
<span style="color: #008000">   requirements.)</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">bool</span> detect_IR() {
  <span style="color: #008000">// Determine if we are receiving an IR signal.</span>
  <span style="color: #008000">//   if pin 12 is false = receiving</span>
  <span style="color: #008000">//   if pin 12 is true = not receiving</span>

  <span style="color: #0000ff">return</span> receiving_IR = (!digitalRead(12));
}

<span style="color: #008000">// SETUP</span>

<span style="color: #2b91af">void</span> setup() {
  Serial.begin(9600);

  pinMode (4, INPUT);      <span style="color: #008000">// Button</span>
  digitalWrite (4, HIGH);  <span style="color: #008000">// Button pull-up resistor</span>

  pinMode (11, OUTPUT);  <span style="color: #008000">// IR LED</span>
  pinMode (12, INPUT);   <span style="color: #008000">// IR receiver</span>

  turn_off_IR();  <span style="color: #008000">// Helper function for controlling the IR LED.</span>
  detect_IR();    <span style="color: #008000">// Ensure the state is correct.</span>

  randomSeed(analogRead(A0));  <span style="color: #008000">// Seed the random number generator.</span>
}

<span style="color: #008000">// LOOP</span>

<span style="color: #2b91af">void</span> loop() {
  <span style="color: #008000">// Check to see if we need to send a message.</span>

  <span style="color: #0000ff">if</span> (read_code == 0)
    code = Serial.read();
  <span style="color: #0000ff">else</span> {
    read_code = 0;
  }

  <span style="color: #0000ff">if</span> (code &gt;= 0) {
    send_message((<span style="color: #2b91af">char</span>)code);  <span style="color: #008000">// Send the message.</span>
    <span style="color: #2b91af">long</span> <span style="color: #2b91af">long</span> send_start = millis();

    <span style="color: #2b91af">char</span> verify = receive_character();  <span style="color: #008000">// Check for verification.</span>

    <span style="color: #008000">// As long as the message cannot be verified, continue to</span>
    <span style="color: #008000">//   attempt to send it.</span>

    <span style="color: #0000ff">while</span> (verify != code) {
      send_message((<span style="color: #2b91af">char</span>)code);

      <span style="color: #0000ff">if</span> (detect_IR())
        verify = receive_character();

      <span style="color: #008000">// A random delay before each message attempt protects against</span>
      <span style="color: #008000">//   conflicts between simultaneous outgoing messages.</span>

      delayMicroseconds(random(100, 200)*d);
      <span style="color: #2b91af">long</span> <span style="color: #2b91af">long</span> send_time = millis();

      <span style="color: #0000ff">if</span> (send_time - send_start &gt; 1000) {
        read_code = 1;
        verify = code;
      }
    }

    <span style="color: #0000ff">if</span> (read_code == 0)
      serial++;  <span style="color: #008000">// Increment the serial number after a successful</span>
                 <span style="color: #008000">//   message receipt.</span>
  }

  <span style="color: #008000">// Check to see if we are receiving a message. Limit the time</span>
  <span style="color: #008000">//   interval in which a message must be successfully received--</span>
  <span style="color: #008000">//   otherwise move on.</span>

  <span style="color: #2b91af">long</span> <span style="color: #2b91af">long</span> wait_time = millis();     <span style="color: #008000">// The time waited for the next message.</span>
  <span style="color: #2b91af">long</span> <span style="color: #2b91af">long</span> receive_time = millis();  <span style="color: #008000">// The time in which the last message was received.</span>

  <span style="color: #0000ff">while</span> (wait_time - receive_time &lt; 50) {
    <span style="color: #0000ff">if</span> (detect_IR()) {
      receive_message();
      receive_time = millis();
    }
    wait_time = millis();
  }
}

<span style="color: #008000">/*</span>
<span style="color: #008000">   Sends a series of IR pulses (as a serial</span>
<span style="color: #008000">   message) that transmits this character to another</span>
<span style="color: #008000">   Arduino board. A start bit is sent, and then</span>
<span style="color: #008000">   the bits of the message are sent in LSB to MSB order.</span>
<span style="color: #008000">   IR on = high bit.</span>

<span style="color: #008000">   All 8 bits of the character are sent.</span>

<span style="color: #008000">   param ch -- the character to send</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">void</span> send_character(<span style="color: #2b91af">char</span> ch) {
  <span style="color: #008000">// Send a start bit and wait.</span>

  turn_on_IR();
  delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 1000));

  <span style="color: #008000">// Send the 8 bits of the character, pausing</span>
  <span style="color: #008000">//   between each bit.</span>

  <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> bitPos = 0; bitPos &lt;= 7; bitPos++) {
    <span style="color: #2b91af">int</span> bit = (ch &gt;&gt; bitPos) &amp; 1;
    <span style="color: #0000ff">if</span> (bit == 1)
      turn_on_IR();
    <span style="color: #0000ff">else</span>
      turn_off_IR();

    delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 1000));
  }

  <span style="color: #008000">// Quiet period.</span>

  turn_off_IR();
  delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 1000));
}

<span style="color: #008000">/*</span>
<span style="color: #008000">   This function assumes that a start bit</span>
<span style="color: #008000">   has been detected. The function waits</span>
<span style="color: #008000">   for and detects the bits of the character,</span>
<span style="color: #008000">   then reassembles the bits and returns the</span>
<span style="color: #008000">   character.</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">char</span> receive_character() {
  <span style="color: #2b91af">char</span> result = 0;

  <span style="color: #008000">// Wait to the center of the first bit.</span>

  delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 1000 * 1.5));

  <span style="color: #008000">// Sample and reassemble the bits, wait for the</span>
  <span style="color: #008000">//   bit after each bit.</span>

  <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> bitPos = 0; bitPos &lt;= 7; bitPos++) {
    <span style="color: #2b91af">int</span> bit = detect_IR() ? 1 : 0;
    result = result | (bit &lt;&lt; bitPos);
    delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 1000));
  }

  <span style="color: #0000ff">return</span> result;
}

<span style="color: #008000">/*</span>
<span style="color: #008000">   Sends a character as part of a package, including</span>
<span style="color: #008000">   a start bit (&#39;2&#39;), the character to send, the</span>
<span style="color: #008000">   message&#39;s serial number (in quantity two, to aid in</span>
<span style="color: #008000">   verification), and the checksum of all these bits.</span>

<span style="color: #008000">   param ch -- the character to send</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">void</span> send_message(<span style="color: #2b91af">char</span> ch) {
  send_character(2);
  send_character(ch);
  send_character(serial);
  send_character(serial);
  send_character(2 + ch + serial);
}

<span style="color: #008000">/*</span>
<span style="color: #008000">   Receives the package transmitted by the send_message</span>
<span style="color: #008000">   function. Will only proceed if it can confirm the</span>
<span style="color: #008000">   start bit (&#39;2&#39;). Verifies the serial number of the</span>
<span style="color: #008000">   package as well as its checksum.</span>
<span style="color: #008000">*/</span>
<span style="color: #2b91af">void</span> receive_message() {
  <span style="color: #2b91af">char</span> test = receive_character();

  <span style="color: #008000">// Proceed only if the perceived start bit is 2.</span>

  <span style="color: #0000ff">if</span> (test == 2) {
    delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 0.5 * 1000));
    <span style="color: #2b91af">char</span> ch = receive_character();

    prev_serial = serial_check;

    delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 0.5 * 1000));
    <span style="color: #2b91af">char</span> serial_check1 = receive_character();

    delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 0.5 * 1000));
    <span style="color: #2b91af">char</span> serial_check2 = receive_character();

    delayMicroseconds((<span style="color: #2b91af">int</span>)(d * 0.5 * 1000));
    <span style="color: #2b91af">char</span> checksum = receive_character();

    <span style="color: #008000">// Verify the serial number.</span>

    <span style="color: #0000ff">if</span> (serial_check1 == serial_check2) {
      serial_check2 = serial_check;
      serial_check = serial_check1;
    }

    <span style="color: #008000">// Construct and verify the checksum.</span>

    <span style="color: #2b91af">char</span> test_checksum = test + ch + serial_check;

    <span style="color: #0000ff">if</span> (test_checksum != checksum) {
      serial_check = serial_check2;
      test_checksum = test + ch + serial_check;
    }

    <span style="color: #008000">// If all tests pass, send the character as confirmation and</span>
    <span style="color: #008000">//   print it out.</span>

    <span style="color: #0000ff">if</span> (checksum == test_checksum) {
      send_character(ch);

      <span style="color: #0000ff">if</span> (prev_serial != serial_check)
        Serial.print((<span style="color: #2b91af">char</span>)ch);
    }
  }
}
</pre></div>
            
            <p id="copyright-mobile">&#169; 2020 Brady Hartog</p>
        </div>
    </div>
</body>
</html>